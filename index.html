<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>书签云管理工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            -webkit-app-region: drag; /* 无边框窗口拖拽区域 */
        }
        
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: #1890ff;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            -webkit-app-region: drag; /* 标题栏可拖拽 */
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 500;
        }
        
        .window-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag; /* 控制按钮不可拖拽 */
        }
        
        .window-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .window-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .window-btn.close:hover {
            background: #ff4d4f;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e8e8e8;
            padding: 0 16px;
        }
        
        .nav-tab {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            -webkit-app-region: no-drag;
        }
        
        .nav-tab.active {
            border-bottom-color: #1890ff;
            color: #1890ff;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e8e8e8;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .config-section {
            margin-bottom: 24px;
        }
        
        .config-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: #666;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            -webkit-app-region: no-drag;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            -webkit-app-region: no-drag;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
        }
        
        .btn-success {
            background: #52c41a;
            color: white;
        }
        
        .btn-success:hover {
            background: #73d13d;
        }
        
        .btn-info {
            background: #1890ff;
            color: white;
        }
        
        .btn-info:hover {
            background: #40a9ff;
        }
        
        .btn-danger {
            background: #ff4d4f;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff7875;
        }
        
        .btn-default {
            background: #fff;
            color: rgba(0, 0, 0, 0.65);
            border: 1px solid #d9d9d9;
        }
        
        .btn-default:hover {
            background: #f5f5f5;
            border-color: #40a9ff;
        }
        
        .content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .tree-panel {
            width: 250px;
            background: white;
            border-right: 1px solid #e8e8e8;
            display: flex;
            flex-direction: column;
        }
        
        .tree-header {
            padding: 16px;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .tree-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .editor-panel {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .editor-header {
            padding: 16px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #ccc;
        }
        
        .tree-node {
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }
        
        .tree-node:hover {
            background: #f0f0f0;
        }
        
        .tree-node.selected {
            background: #e6f7ff;
            border-color: #1890ff;
        }
        
        .tree-node i {
            width: 16px;
            text-align: center;
        }
        
        .tree-children {
            margin-left: 20px;
        }
        
        .bookmark-list {
            width: 100%;
            border-collapse: collapse;
        }
        
        .bookmark-list th, .bookmark-list td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .bookmark-list th {
            background: #fafafa;
            font-weight: 500;
        }
        
        .favicon-cell {
            width: 30px;
        }
        
        .favicon-cell img {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        .url-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .actions-cell {
            width: 120px;
        }
        
        .action-btn {
            padding: 4px 8px;
            margin-right: 4px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .action-btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .action-btn-info {
            background: #1890ff;
            color: white;
        }
        
        .action-btn-danger {
            background: #ff4d4f;
            color: white;
        }
        
        .status-bar {
            padding: 8px 16px;
            background: #f0f0f0;
            border-top: 1px solid #e8e8e8;
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #1890ff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .hidden {
            display: none;
        }
        
        /* 设置页面样式 */
        .settings-page {
            padding: 24px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .settings-page h2 {
            margin-bottom: 24px;
            color: #333;
        }
        
        .settings-form {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <div class="header">
            <h1><i class="fa fa-bookmark"></i> 书签云管理工具</h1>
            <div class="window-controls">
                <button class="window-btn" id="minimizeBtn">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="window-btn" id="maximizeBtn">
                    <i class="fa fa-square-o"></i>
                </button>
                <button class="window-btn close" id="closeBtn">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="main">主界面</div>
            <div class="nav-tab" data-tab="settings">设置</div>
        </div>
        
        <div class="main-container" id="mainContainer">
            <div class="sidebar">
                <div class="sidebar-content">
                    <div class="config-section">
                        <h3>GitHub配置</h3>
                        <div class="form-group">
                            <label for="repoUrl">仓库地址</label>
                            <input type="text" id="repoUrl" placeholder="例如: https://raw.githubusercontent.com/username/repo/main/bookmarks.json">
                        </div>
                        <div class="form-group" id="tokenGroup" style="display: none;">
                            <label for="token">访问Token (可选)</label>
                            <input type="password" id="token" placeholder="GitHub Personal Access Token">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="loadBtn">
                                <i class="fa fa-download"></i> 加载书签
                            </button>
                            <button class="btn btn-default" id="toggleTokenBtn">需要Token?</button>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h3>操作</h3>
                        <div class="btn-group">
                            <button class="btn btn-success" id="saveBtn">
                                <i class="fa fa-save"></i> 保存到本地
                            </button>
                            <button class="btn btn-info" id="addFolderBtn">
                                <i class="fa fa-folder"></i> 添加文件夹
                            </button>
                            <button class="btn btn-info" id="addBookmarkBtn">
                                <i class="fa fa-link"></i> 添加书签
                            </button>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h3>搜索</h3>
                        <div class="form-group">
                            <input type="text" id="searchInput" placeholder="搜索书签或标签...">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div class="tree-panel">
                    <div class="tree-header">
                        <h3>书签结构</h3>
                    </div>
                    <div class="tree-content" id="bookmarkTree">
                        <div class="empty-state">
                            <i class="fa fa-info-circle"></i>
                            <p>没有书签数据，请先加载</p>
                        </div>
                    </div>
                </div>
                
                <div class="editor-panel">
                    <div class="editor-header">
                        <h3 id="editorTitle">编辑区域</h3>
                        <button class="btn btn-danger" id="deleteBtn" disabled>
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </div>
                    <div class="editor-content" id="editorArea">
                        <div class="empty-state">
                            <i class="fa fa-hand-pointer-o"></i>
                            <p>请从左侧选择一个书签或文件夹进行编辑</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-container hidden" id="settingsContainer">
            <div class="settings-page">
                <h2><i class="fa fa-cog"></i> 设置</h2>
                <div class="settings-form">
                    <div class="form-group">
                        <label for="settingsRepoUrl">GitHub仓库地址</label>
                        <input type="text" id="settingsRepoUrl" placeholder="例如: https://raw.githubusercontent.com/username/repo/main/bookmarks.json">
                    </div>
                    <div class="form-group">
                        <label for="settingsToken">访问Token (可选)</label>
                        <input type="password" id="settingsToken" placeholder="GitHub Personal Access Token">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="saveSettingsBtn">
                            <i class="fa fa-save"></i> 保存设置
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-bar" id="statusBar">
            就绪
        </div>
    </div>

    <script>
        // 全局变量
        let bookmarksData = null;
        let selectedNode = null;
        let selectedParent = null;
        let currentTab = 'main';
        
        // DOM元素
        const elements = {
            repoUrl: document.getElementById('repoUrl'),
            token: document.getElementById('token'),
            tokenGroup: document.getElementById('tokenGroup'),
            toggleTokenBtn: document.getElementById('toggleTokenBtn'),
            loadBtn: document.getElementById('loadBtn'),
            saveBtn: document.getElementById('saveBtn'),
            addFolderBtn: document.getElementById('addFolderBtn'),
            addBookmarkBtn: document.getElementById('addBookmarkBtn'),
            searchInput: document.getElementById('searchInput'),
            bookmarkTree: document.getElementById('bookmarkTree'),
            editorArea: document.getElementById('editorArea'),
            editorTitle: document.getElementById('editorTitle'),
            deleteBtn: document.getElementById('deleteBtn'),
            statusBar: document.getElementById('statusBar'),
            mainContainer: document.getElementById('mainContainer'),
            settingsContainer: document.getElementById('settingsContainer'),
            settingsRepoUrl: document.getElementById('settingsRepoUrl'),
            settingsToken: document.getElementById('settingsToken'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn')
        };
        
        // 窗口控制按钮
        document.getElementById('minimizeBtn').addEventListener('click', () => {
            window.electronAPI.minimizeWindow();
        });
        
        document.getElementById('maximizeBtn').addEventListener('click', () => {
            window.electronAPI.maximizeWindow();
        });
        
        document.getElementById('closeBtn').addEventListener('click', () => {
            window.electronAPI.quitApp();
        });
        
        // 标签页切换
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // 更新激活状态
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // 切换内容
                const tabName = tab.dataset.tab;
                if (tabName === 'main') {
                    elements.mainContainer.classList.remove('hidden');
                    elements.settingsContainer.classList.add('hidden');
                    currentTab = 'main';
                } else if (tabName === 'settings') {
                    elements.mainContainer.classList.add('hidden');
                    elements.settingsContainer.classList.remove('hidden');
                    currentTab = 'settings';
                    loadSettings();
                }
            });
        });
        
        // 加载设置
        async function loadSettings() {
            try {
                const config = await window.electron.ipcRenderer.invoke('get-config');
                elements.settingsRepoUrl.value = config.repoUrl || '';
                elements.settingsToken.value = config.token || '';
            } catch (error) {
                console.error('加载设置失败:', error);
            }
        }
        
        // 保存设置
        document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
            try {
                const config = {
                    repoUrl: elements.settingsRepoUrl.value.trim(),
                    token: elements.settingsToken.value.trim()
                };
                
                await window.electron.ipcRenderer.invoke('save-config', config);
                
                // 同时更新主界面的配置
                elements.repoUrl.value = config.repoUrl;
                elements.token.value = config.token;
                
                showStatus('设置已保存');
            } catch (error) {
                showStatus('保存设置失败: ' + error.message, true);
            }
        });
        
        // 生成唯一ID
        function generateId(prefix = 'item') {
            return `${prefix}_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
        }
        
        // 生成ISO时间戳
        function getIsoTimestamp() {
            return new Date().toISOString();
        }
        
        // 显示状态信息
        function showStatus(message, isError = false) {
            elements.statusBar.textContent = message;
            elements.statusBar.style.color = isError ? '#ff4d4f' : '#666';
        }
        
        // 渲染书签树形结构
        function renderBookmarkTree() {
            if (!bookmarksData || !bookmarksData.roots) {
                elements.bookmarkTree.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-info-circle"></i>
                        <p>没有书签数据，请先加载</p>
                    </div>
                `;
                return;
            }
            
            elements.bookmarkTree.innerHTML = '';
            
            // 递归渲染节点
            function renderNode(node, container, level = 0) {
                const nodeEl = document.createElement('div');
                nodeEl.className = `tree-node ${selectedNode?.id === node.id ? 'selected' : ''}`;
                nodeEl.dataset.id = node.id;
                nodeEl.dataset.type = node.type;
                nodeEl.style.paddingLeft = `${8 + level * 16}px`;
                
                // 图标
                const icon = node.type === 'folder' ? 
                    '<i class="fa fa-folder text-yellow"></i>' : 
                    '<i class="fa fa-link text-blue"></i>';
                
                nodeEl.innerHTML = `
                    ${icon}
                    <span>${node.name}</span>
                `;
                
                // 点击事件
                nodeEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectNode(node);
                });
                
                container.appendChild(nodeEl);
                
                // 渲染子节点
                if (node.type === 'folder' && node.children && node.children.length > 0) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'tree-children';
                    node.children.forEach(child => renderNode(child, childrenContainer, level + 1));
                    container.appendChild(childrenContainer);
                }
            }
            
            // 渲染根节点
            Object.values(bookmarksData.roots).forEach(root => {
                renderNode(root, elements.bookmarkTree, 0);
            });
        }
        
        // 选择节点
        function selectNode(node) {
            selectedNode = node;
            elements.deleteBtn.disabled = false;
            elements.editorTitle.textContent = node.type === 'folder' ? '文件夹信息' : '书签信息';
            
            // 更新树形结构选中状态
            document.querySelectorAll('.tree-node').forEach(el => {
                el.classList.toggle('selected', el.dataset.id === node.id);
            });
            
            // 渲染编辑表单
            renderEditorForm(node);
        }
        
        // 渲染编辑表单
        function renderEditorForm(node) {
            const formHtml = `
                <div class="form-group">
                    <label for="nodeName">名称</label>
                    <input type="text" id="nodeName" value="${node.name || ''}">
                </div>
                
                ${node.type === 'bookmark' ? `
                    <div class="form-group">
                        <label for="nodeUrl">URL</label>
                        <input type="url" id="nodeUrl" value="${node.url || ''}">
                    </div>
                    <div class="form-group">
                        <label for="nodeFavicon">图标URL (可选)</label>
                        <input type="url" id="nodeFavicon" value="${node.favicon || ''}">
                    </div>
                    <div class="form-group">
                        <label for="nodeTags">标签 (用逗号分隔)</label>
                        <input type="text" id="nodeTags" value="${node.tags ? node.tags.join(', ') : ''}">
                    </div>
                ` : ''}
                
                <div class="form-group">
                    <label>创建时间</label>
                    <input type="text" value="${node.createdAt || '未知'}" readonly>
                </div>
                
                <div class="form-group">
                    <label>更新时间</label>
                    <input type="text" value="${node.updatedAt || '未知'}" readonly>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="saveChangesBtn">
                        <i class="fa fa-save"></i> 保存修改
                    </button>
                </div>
                
                ${node.type === 'folder' && node.children && node.children.length > 0 ? `
                    <div style="margin-top: 24px;">
                        <h3>书签列表</h3>
                        <table class="bookmark-list">
                            <thead>
                                <tr>
                                    <th class="favicon-cell"></th>
                                    <th>名称</th>
                                    <th>URL</th>
                                    <th class="actions-cell">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${node.children.filter(child => child.type === 'bookmark').map(bookmark => `
                                    <tr>
                                        <td class="favicon-cell">
                                            ${bookmark.favicon ? 
                                                `<img src="${bookmark.favicon}" onerror="this.style.display='none'">` : 
                                                '<i class="fa fa-link"></i>'}
                                        </td>
                                        <td>${bookmark.name}</td>
                        <td class="url-cell"><a href="${bookmark.url}" target="_blank">${bookmark.url}</a></td>
                                        <td class="actions-cell">
                                            <button class="action-btn action-btn-primary open-bookmark" data-url="${bookmark.url}">
                                                打开
                                            </button>
                                            <button class="action-btn action-btn-info edit-bookmark" data-id="${bookmark.id}">
                                                编辑
                                            </button>
                                            <button class="action-btn action-btn-danger delete-bookmark" data-id="${bookmark.id}">
                                                删除
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            `;
            
            elements.editorArea.innerHTML = formHtml;
            
            // 绑定事件
            document.getElementById('saveChangesBtn').addEventListener('click', saveNodeChanges);
            
            // 绑定书签列表中的事件
            document.querySelectorAll('.open-bookmark').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.open(btn.dataset.url, '_blank');
                });
            });
            
            document.querySelectorAll('.edit-bookmark').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const bookmark = findNodeById(btn.dataset.id);
                    if (bookmark) selectNode(bookmark);
                });
            });
            
            document.querySelectorAll('.delete-bookmark').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteBookmark(btn.dataset.id);
                });
            });
        }
        
        // 保存节点修改
        function saveNodeChanges() {
            if (!selectedNode) return;
            
            // 更新基本信息
            selectedNode.name = document.getElementById('nodeName').value.trim();
            selectedNode.updatedAt = getIsoTimestamp();
            
            // 如果是书签，更新额外信息
            if (selectedNode.type === 'bookmark') {
                selectedNode.url = document.getElementById('nodeUrl').value.trim();
                selectedNode.favicon = document.getElementById('nodeFavicon').value.trim() || undefined;
                
                // 处理标签
                const tags = document.getElementById('nodeTags').value.trim();
                selectedNode.tags = tags ? tags.split(',').map(tag => tag.trim()) : undefined;
            }
            
            showStatus('修改已保存');
            renderBookmarkTree();
            renderEditorForm(selectedNode);
        }
        
        // 查找节点
        function findNodeById(id, nodes = bookmarksData ? Object.values(bookmarksData.roots) : []) {
            for (const node of nodes) {
                if (node.id === id) return node;
                if (node.children && node.children.length > 0) {
                    const found = findNodeById(id, node.children);
                    if (found) return found;
                }
            }
            return null;
        }
        
        // 查找父节点
        function findParentNode(targetId, nodes = bookmarksData ? Object.values(bookmarksData.roots) : []) {
            for (const node of nodes) {
                if (node.children && node.children.some(child => child.id === targetId)) {
                    return { parent: node, index: node.children.findIndex(child => child.id === targetId) };
                }
                
                if (node.children && node.children.length > 0) {
                    const result = findParentNode(targetId, node.children);
                    if (result) return result;
                }
            }
            return null;
        }
        
        // 添加新节点
        function addNewNode(type) {
            if (!bookmarksData || !bookmarksData.roots) {
                showStatus('请先加载书签数据', true);
                return;
            }
            
            // 确定父节点
            let parentNode;
            if (selectedNode && selectedNode.type === 'folder') {
                parentNode = selectedNode;
            } else {
                // 默认添加到第一个根目录
                parentNode = Object.values(bookmarksData.roots)[0];
            }
            
            // 创建新节点
            const newNode = {
                id: generateId(type === 'folder' ? 'folder' : 'bookmark'),
                name: type === 'folder' ? '新文件夹' : '新书签',
                type: type,
                createdAt: getIsoTimestamp(),
                updatedAt: getIsoTimestamp(),
                children: type === 'folder' ? [] : undefined
            };
            
            // 如果是书签，添加默认URL
            if (type === 'bookmark') {
                newNode.url = 'https://';
                newNode.tags = [];
            }
            
            // 添加到父节点
            if (!parentNode.children) parentNode.children = [];
            parentNode.children.push(newNode);
            
            showStatus(`已添加新${type === 'folder' ? '文件夹' : '书签'}`);
            renderBookmarkTree();
            selectNode(newNode);
        }
        
        // 删除选中的节点
        function deleteSelectedNode() {
            if (!selectedNode) return;
            
            if (!confirm(`确定要删除"${selectedNode.name}"吗？`)) {
                return;
            }
            
            // 查找父节点
            const parentInfo = findParentNode(selectedNode.id);
            
            if (parentInfo && parentInfo.parent && parentInfo.parent.children) {
                // 从父节点的children中移除
                parentInfo.parent.children.splice(parentInfo.index, 1);
                showStatus('已删除节点');
                
                // 重置选择状态
                selectedNode = null;
                elements.deleteBtn.disabled = true;
                elements.editorTitle.textContent = '编辑区域';
                elements.editorArea.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-hand-pointer-o"></i>
                        <p>请从左侧选择一个书签或文件夹进行编辑</p>
                    </div>
                `;
                
                renderBookmarkTree();
            } else {
                showStatus('无法删除根节点', true);
            }
        }
        
        // 删除书签
        function deleteBookmark(bookmarkId) {
            if (!confirm('确定要删除这个书签吗？')) {
                return;
            }
            
            // 查找父节点
            const parentInfo = findParentNode(bookmarkId);
            
            if (parentInfo && parentInfo.parent && parentInfo.parent.children) {
                // 从父节点的children中移除
                parentInfo.parent.children.splice(parentInfo.index, 1);
                showStatus('书签已删除');
                
                // 重新渲染当前选中文件夹的列表
                if (selectedNode && selectedNode.type === 'folder') {
                    renderEditorForm(selectedNode);
                }
                
                renderBookmarkTree();
            } else {
                showStatus('删除失败', true);
            }
        }
        
        // 从GitHub加载书签
        async function loadBookmarks() {
            const repoUrl = elements.repoUrl.value.trim();
            const token = elements.token.value.trim();
            
            if (!repoUrl) {
                showStatus('请填写仓库地址', true);
                return;
            }
            
            try {
                showStatus('正在加载书签数据...');
                
                // 构造请求头
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }
                
                // 发送请求
                const response = await fetch(repoUrl, { headers });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // 初始化默认数据
                        bookmarksData = {
                            "version": "1.0",
                            "roots": {
                                "bookmark_bar": {
                                    "id": "root_1",
                                    "name": "书签栏",
                                    "type": "folder",
                                    "createdAt": getIsoTimestamp(),
                                    "updatedAt": getIsoTimestamp(),
                                    "children": []
                                },
                                "other_bookmarks": {
                                    "id": "root_2",
                                    "name": "其他书签",
                                    "type": "folder",
                                    "createdAt": getIsoTimestamp(),
                                    "updatedAt": getIsoTimestamp(),
                                    "children": []
                                }
                            }
                        };
                        showStatus('未找到书签文件，已初始化新的书签数据');
                        renderBookmarkTree();
                        return;
                    }
                    throw new Error(`HTTP错误：${response.status} ${response.statusText}`);
                }
                
                // 检查响应的内容类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    if (!text.trim()) {
                        throw new Error('服务器返回空内容');
                    }
                    throw new Error(`服务器返回非JSON内容: ${contentType || '未知类型'}`);
                }
                
                // 获取响应文本，先检查是否为有效的JSON
                const text = await response.text();
                if (!text.trim()) {
                    throw new Error('服务器返回空内容');
                }
                
                bookmarksData = JSON.parse(text);
                
                // 验证解析后的数据结构是否正确
                if (!bookmarksData || typeof bookmarksData !== 'object') {
                    throw new Error('书签数据不是有效的对象');
                }
                
                if (!bookmarksData.roots) {
                    throw new Error('书签数据结构不正确，缺少必要的roots字段');
                }
                
                showStatus('书签数据加载成功');
                renderBookmarkTree();
            } catch (error) {
                console.error('加载错误：', error);
                showStatus(`加载失败：${error.message}`, true);
                
                // 网络错误等情况下也提供回退选项
                if (!bookmarksData && confirm(`加载失败：${error.message}\n是否初始化新的书签数据？`)) {
                    bookmarksData = {
                        "version": "1.0",
                        "roots": {
                            "bookmark_bar": {
                                "id": "root_1",
                                "name": "书签栏",
                                "type": "folder",
                                "createdAt": getIsoTimestamp(),
                                "updatedAt": getIsoTimestamp(),
                                "children": []
                            },
                            "other_bookmarks": {
                                "id": "root_2",
                                "name": "其他书签",
                                "type": "folder",
                                "createdAt": getIsoTimestamp(),
                                "updatedAt": getIsoTimestamp(),
                                "children": []
                            }
                        }
                    };
                    renderBookmarkTree();
                }
            }
        }
        
        // 保存书签到本地
        function saveBookmarks() {
            if (!bookmarksData) {
                showStatus('没有可保存的书签数据', true);
                return;
            }
            
            try {
                // 创建下载链接
                const jsonContent = JSON.stringify(bookmarksData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // 创建下载链接
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bookmarks.json';
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showStatus('书签数据已准备下载');
                }, 100);
                
            } catch (error) {
                showStatus(`保存失败：${error.message}`, true);
                console.error('保存错误：', error);
            }
        }
        
        // 切换Token输入框显示
        function toggleTokenInput() {
            const isHidden = elements.tokenGroup.style.display === 'none';
            elements.tokenGroup.style.display = isHidden ? 'block' : 'none';
            elements.toggleTokenBtn.textContent = isHidden ? '隐藏Token' : '需要Token?';
        }
        
        // 事件绑定
        document.addEventListener('DOMContentLoaded', () => {
            // 按钮事件
            elements.loadBtn.addEventListener('click', loadBookmarks);
            elements.saveBtn.addEventListener('click', saveBookmarks);
            elements.addFolderBtn.addEventListener('click', () => addNewNode('folder'));
            elements.addBookmarkBtn.addEventListener('click', () => addNewNode('bookmark'));
            elements.deleteBtn.addEventListener('click', deleteSelectedNode);
            elements.toggleTokenBtn.addEventListener('click', toggleTokenInput);
            
            // 搜索事件
            elements.searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query) {
                    searchBookmarks(query);
                } else {
                    renderBookmarkTree();
                }
            });
            
            // 页面加载时加载配置
            loadConfig();
        });
        
        // 加载配置
        async function loadConfig() {
            try {
                const config = await window.electron.ipcRenderer.invoke('get-config');
                elements.repoUrl.value = config.repoUrl || '';
                elements.token.value = config.token || '';
            } catch (error) {
                console.error('加载配置失败:', error);
            }
        }
        
        // 搜索书签
        function searchBookmarks(query) {
            if (!query || !bookmarksData) return;
            
            query = query.toLowerCase();
            const results = [];
            
            // 递归搜索
            function searchInNode(node, path = []) {
                const currentPath = [...path, node.name];
                
                // 检查名称是否匹配
                if (node.name.toLowerCase().includes(query)) {
                    results.push({
                        node,
                        path: currentPath.join(' > ')
                    });
                }
                
                // 检查标签是否匹配（仅书签）
                if (node.type === 'bookmark' && node.tags) {
                    if (node.tags.some(tag => tag.toLowerCase().includes(query))) {
                        results.push({
                            node,
                            path: currentPath.join(' > ')
                        });
                    }
                }
                
                // 检查URL是否匹配（仅书签）
                if (node.type === 'bookmark' && node.url) {
                    if (node.url.toLowerCase().includes(query)) {
                        results.push({
                            node,
                            path: currentPath.join(' > ')
                        });
                    }
                }
                
                // 搜索子节点
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => searchInNode(child, currentPath));
                }
            }
            
            // 从所有根节点开始搜索
            Object.values(bookmarksData.roots).forEach(root => searchInNode(root));
            
            // 显示结果
            if (results.length === 0) {
                elements.bookmarkTree.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-search"></i>
                        <p>没有找到匹配的结果</p>
                    </div>
                `;
            } else {
                elements.bookmarkTree.innerHTML = `<div style="padding: 8px; font-size: 12px; color: #666;">找到 ${results.length} 个匹配结果</div>`;
                const resultsContainer = document.createElement('div');
                
                results.forEach(item => {
                    const resultEl = document.createElement('div');
                    resultEl.className = 'tree-node';
                    resultEl.dataset.id = item.node.id;
                    
                    const icon = item.node.type === 'folder' ? 
                        '<i class="fa fa-folder text-yellow"></i>' : 
                        '<i class="fa fa-link text-blue"></i>';
                    
                    resultEl.innerHTML = `
                        ${icon}
                        <span>${item.node.name}</span>
                    `;
                    
                    resultEl.addEventListener('click', () => {
                        selectNode(item.node);
                    });
                    
                    resultsContainer.appendChild(resultEl);
                });
                
                elements.bookmarkTree.appendChild(resultsContainer);
            }
        }
        
        // 设置Electron API
        window.electron = {
            ipcRenderer: {
                invoke: async (channel, ...args) => {
                    // 在Electron环境中，这些会被真实的IPC方法替换
                    if (channel === 'quit-app') {
                        // 模拟退出应用
                        console.log('退出应用');
                    } else if (channel === 'get-config') {
                        // 模拟获取配置
                        return {
                            repoUrl: localStorage.getItem('repoUrl') || '',
                            token: localStorage.getItem('token') || ''
                        };
                    } else if (channel === 'save-config') {
                        // 模拟保存配置
                        const config = args[0];
                        localStorage.setItem('repoUrl', config.repoUrl || '');
                        localStorage.setItem('token', config.token || '');
                        return { success: true };
                    } else if (channel === 'minimize-window') {
                        // 模拟最小化窗口
                        console.log('最小化窗口');
                    } else if (channel === 'maximize-window') {
                        // 模拟最大化窗口
                        console.log('最大化窗口');
                    }
                }
            }
        };
    </script>
</body>
</html>